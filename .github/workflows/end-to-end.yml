name: End-to-end

on:
  push:


jobs:
  end-to-end:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8' # Version range or exact version of a Python version to use, using SemVer's version range syntax
          architecture: 'x64'
      -
        name: boot
        run: |
          docker-compose up -d
          sleep 20
      -
        name: Api OK
        run: |
          curl localhost:8000/api/ok | grep status
          curl localhost:8000/api/ok | grep ok

      - name: Celery-admin POST /periodic-tasks
        run: |
          result_create=$(curl -X POST -H "Content-Type: application/json" -d "{\"status\": \"asdfdd\", \"name\": \"taskname\", \"task\": \"hello\"}" localhost:8000/api/periodic-tasks/)
          echo $result_create | grep "taskname"

          task_id=$(echo $result_create | jq .id)
          result_latest=$(curl  localhost:8000/api/periodic-tasks/latest)
          echo $result_latest | grep "\"id\":$task_id"

